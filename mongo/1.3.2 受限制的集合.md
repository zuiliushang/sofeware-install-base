# 受限制的集合

## 概述

受限制集合是固定大小的集合来支持高通量的插入和恢复文档的基于插入顺序操作。受限制集合工作的方式类似一个循环的缓存：一旦一个集合填充了其分配的空间，它就会通过覆盖集合中最古老的文档来为新文档腾出空间。

## 行为举动

### 插入顺序

受限制的集合保证保留插入的顺序。这个的影响就是，查询不需要索引以在插入顺序中返回文档。

### 自动删除最老的文档

为了给新文件腾出空间。受限集合会自动的删除最老的文档而不需要脚本或者明显的删除操作。

例如，```oplog.rs```集合存储一个关于操作在一个副本级别的log，使用的是一个受限制的集合。考虑以下为限定集合的潜在用例：

- 存储由大容量系统生成的日志信息。在没有索引的限制集合中插入文档接近于将日志信息直接写入文件系统的速度。此外，内置的先入先出的属性维护事件的顺序，同时管理存储的使用。
- 缓存小而多的数据在受限制的集合。因为缓存是读而不是写重的，您可能需要确保该集合始终保持在工作集中(即在RAM中)，或者接受对所需索引或索引的一些写入惩罚。

### \_id 索引

受限制的集合默认有一个```\_id```属性和这个```\_id```属性的索引。

## 限制和建议

### Update 更新

如果你想在一个受限制的集合中更新文档，创建一个索引是的这些更新炒作不需要一次集合扫描。(创建索引减少一次扫描)

### 文档大小

*version3.2 变动*

如果一个更新或者一个覆盖操作改变了文档大小，这个操作会失败 。

### 文档删除

你不能从受限制集合删除文档。为了删除集合中所有的文档，使用```drop()```方法删除掉集合然后重新创建一个集合。

### 碎片化

你不能碎片化一个受限制的集合。

### 查询效率

使用自然排序来有效地从集合中检索最近插入的元素。这在某种程度上类似于日志文件中的tail。

### 聚合$out

在受限制集合中聚合管道操作$out不能得到一个写结果。

## 程序

### 创建一个受限制集合

你可以使用```db.createCollection()```方法来创建一个受限制的集合。这个是一个MongoShell的创建命令。当创建一个受限制集合你必须制定这个集合的最大byte大小。MongoDB将预先分配这些集合。上限集合的大小包括内部开销的一小部分空间。

<pre>
> db.createCollection("log", { capped: true,size: 100000})
{ "ok" : 1 }
</pre>

如果属性大小小于4096，那么集合会设置该集合的上限为4096字节。否则，MongoDB将提高所提供的大小，使其成为256的整数倍。

此外，你可以指定一个文档的大小数字在一个集合中使用最大属性:

<pre>
> db.createCollection("log2",{capped: true, size: 5242880, max: 5000})
{ "ok" : 1 }
</pre>

> 重要:大小参数总是需要。甚至当你指定文档的最大数量时。MongoDB将会删除老的文档如果一个集合在达到最大文档计数之前达到最大大小限制。

### 查询一个受限制的集合

如果你执行一个```find()```在一个受限制的集合中没有排序要求，MongoDB保证结果顺序保持和插入顺序一致。

为了渠道数据有一个和插入顺序反顺序。```find()```和```sort()```方法联合使用将$natural参数设置为-1，例如:
<pre>
 db.log2.find().sort({$natural: -1})
</pre>

### 检查集合是不是Capped

使用```isCapped()```方法来验证一个集合是不是受限制的.：
<pre>
> db.log2.isCapped()
true
</pre>

### 转化一个集合为Capped

你可以转化一个 non-capped 集合为 capped集合使用 ```convertToCapped```命令:

<pre>
> db.runCommand({"convertToCapped":"log2",size: 100000})
{ "ok" : 1 }
</pre>

size仓鼠指定capped集合的byte大小。

这在操作期间持有一个数据库独占锁。其他锁库操作将会阻塞知道操作完成。

### 超过一个指定的时间自动删除数据

capped集合的一个替代品是使用MongoDB TTL索引。这个索引允许你过期并删除数据从正常集合。

> 重要：TTL索引与capped集合不兼容。

### Tailable Cursor

可以使用一个tailable cursor在capped集合。类似Unix tail -f 命令。